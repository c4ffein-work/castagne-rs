# Integration Tests - Parser Golden Master Validation

This document explains how to run the Castagne-RS parser integration tests that compare the Rust parser output against golden masters generated by the Godot 3 parser.

## Overview

The integration test framework validates that the Rust parser produces identical output to the Godot 3 + GDScript parser by:

1. Parsing a `.casp` file with the Rust parser
2. Serializing the Rust parser output to JSON
3. Loading the corresponding golden master JSON (generated from Godot 3)
4. Performing deep comparison between the two JSON structures
5. Reporting differences with detailed paths

## Files

### Test Runner (Rust)

- **`src/test_runner.rs`**: Contains `CastagneTestRunner` class with integration test methods
  - `test_parser_simple()`: Test simple `test_character_complete.casp` file
  - `test_parser_basic_character()`: Test `Baston-Model.casp`
  - `test_parser_complete_character()`: Test `Baston-2D.casp`
  - `test_parser_advanced_character()`: Test `TutorialBaston.casp`
  - `test_parser_with_golden_master()`: Core comparison logic

### Test Launcher (GDScript)

- **`run_parser_tests.gd`**: Simple GDScript launcher for running tests
  - Can be attached to a Node in Godot editor
  - Can be run from command line in headless mode

### Golden Masters

- **`golden_masters/`**: Directory containing JSON golden masters
  - `test_character_complete.json`: Simple test file (good for initial testing)
  - `Baston-Model.json`: Complex character with skeleton inheritance
  - `Baston-2D.json`: Character that inherits from Baston-Model
  - `TutorialBaston.json`: Tutorial character example

## Running Tests

### Option 1: From Godot Editor

1. Open the project in Godot
2. Create a new Scene with a Node
3. Attach the script `run_parser_tests.gd` to the Node
4. Run the scene (F5)
5. Check the Output console for results

### Option 2: From Command Line (Headless)

```bash
# Run tests headless
godot --script run_parser_tests.gd
```

### Option 3: From Godot's SceneTree (Advanced)

If you have a running Godot instance:

```gdscript
# In Godot's script console or from another script:
var test_runner = CastagneTestRunner.new()
add_child(test_runner)

# Run single test
var result = test_runner.test_parser_simple()
print("Test passed: ", result)

# Or run full test suite
var results = test_runner.run_comparison_tests()
for test_name in results.keys():
    print("%s: %s" % [test_name, "PASS" if results[test_name] else "FAIL"])
```

## Test Output

### Success Output

When a test passes, you'll see:

```
=== Castagne-RS Parser Comparison Tests ===

TEST 1: Simple character (test_character_complete)
============================================================
Testing parser comparison (test_character_complete)...
  → Loading golden master: golden_masters/test_character_complete.json
  → Parsing .casp file with Rust parser: test_character_complete.casp
  → Serializing Rust parser output to JSON
  → Comparing parser outputs...
  ✅ Perfect match! Rust parser output matches golden master exactly.

✅ Simple test PASSED
```

### Failure Output (with differences)

When differences are found:

```
Testing parser comparison (Baston-Model)...
  → Loading golden master: golden_masters/Baston-Model.json
  → Parsing .casp file with Rust parser: castagne/examples/fighters/baston/Baston-Model.casp
  → Serializing Rust parser output to JSON
  → Comparing parser outputs...
  ⚠️  Found 15 differences between Rust parser and golden master:
    1: states.Idle.actions.Init[0].args: array length mismatch (Rust: 2, Golden: 3)
    2: states.Walk: missing in Rust output
    3: transformed_data.Graphics: missing in Rust output
    ... and 12 more differences
  → Summary:
    Rust metadata.name: Baston Labatte
    Golden metadata.name: Baston Labatte
    Rust states count: 250
    Golden states count: 300
    Rust variables count: 3
    Golden variables count: 3
```

## Test Structure

### Parser Comparison Logic

The `test_parser_with_golden_master` method:

1. **Load Golden Master**: Reads and parses the JSON file
2. **Parse with Rust**: Uses `CastagneParser::create_full_character()`
3. **Serialize**: Converts `ParsedCharacter` to JSON via `to_json_value()`
4. **Deep Compare**: Recursively compares JSON trees with `compare_json_recursive()`
5. **Report**: Shows first 10 differences plus summary statistics

### Comparison Algorithm

The recursive comparison (`compare_json_recursive`) checks:

- **Missing keys**: Fields present in golden master but not in Rust output
- **Extra keys**: Fields in Rust output but not in golden master
- **Value mismatches**: Different values for same field
- **Array length**: Different array sizes
- **Type mismatches**: Different JSON value types

## Current Test Status

As of 2025-11-09:

### Cargo Tests (No Godot Runtime)

```bash
cargo test --test golden_master_tests --test parser_comparison
```

- ✅ **7 validation tests** passing (verify golden master structure)
- ✅ **5 comparison tests** passing (validate comparison framework)
- ⏳ **1 ignored** (example test requiring actual parser)

### Integration Tests (Requires Godot)

- ✅ **Test infrastructure ready**
- ⏳ **Awaiting parser implementation** for full comparison
- ⏳ Tests will report differences as parser is developed

## Expected Behavior

Currently, the Rust parser is in early development. Tests will:

1. **Pass basic checks**: Parser loads files, no crashes
2. **Report differences**: Shows what's missing or different
3. **Allow warnings**: Returns `true` if metadata name matches (lenient mode)

As the parser improves:

1. Fewer differences will be reported
2. More tests will pass completely
3. Eventually: Perfect match with golden masters

## Debugging

### Common Issues

**"Failed to load golden master"**
- Ensure `golden_masters/` directory exists
- Check file paths are correct
- Verify golden masters were generated

**"Rust parser failed to parse"**
- Check the `.casp` file path
- Look at `parser.errors` for details
- Parser might not support all features yet

**"Failed to serialize Rust parser output"**
- Check that all parser structures have `Serialize` derives
- Verify no circular references in data structures

### Adding New Tests

To add a new test file:

1. Generate golden master with Godot 3 parser (see `scripts/README_GOLDEN_MASTERS.md`)
2. Place JSON in `golden_masters/` directory
3. Add test method to `src/test_runner.rs`:

```rust
#[func]
pub fn test_my_character(&mut self) -> bool {
    godot_print!("Testing my character...");
    self.test_parser_with_golden_master(
        "path/to/my_character.casp",
        "golden_masters/my_character.json"
    )
}
```

4. Update `run_parser_tests.gd` to call new test

## Next Steps

1. **Implement Parser Features**: Add missing functionality to match GDScript parser
2. **Run Tests Frequently**: Use tests to verify changes don't break compatibility
3. **Fix Differences**: Work through reported differences one by one
4. **Document Intentional Differences**: If Rust parser intentionally differs, document why

## Related Documentation

- **GOLDEN_MASTER_VALIDATION.md**: Overview of validation progress
- **scripts/README_GOLDEN_MASTERS.md**: How to generate golden masters
- **tests/parser_comparison.rs**: Standalone comparison test examples

## Support

If tests fail unexpectedly:

1. Check that golden masters are up to date
2. Verify Rust parser compiles without errors
3. Look at detailed difference output
4. Compare specific fields manually if needed

The integration test framework is designed to be informative and help guide parser development, not to block progress!
